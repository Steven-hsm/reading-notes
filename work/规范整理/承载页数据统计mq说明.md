# 概述

> 1. 数据统计需要实时处理,放在业务逻辑中过于繁琐,通过mq的方式将数据统计模块抽出.
> 2. 这部分数据统计需要和承载页关联，同时和链路跟踪关联，所以mq需要发送很多关于链路的参数

## 参数说明

> 1. 以下参数为所有的接口公用参数
> 2. 如果入参中存在部分表的主键,可以省略这部分参数
> 3. 具体的参数值,根据当前的场景,比如活动页相关的数据即存放活动相关的数据

| 字段名称        | 类型 | 默认值 | 是否可为空 | 说明             |
| --------------- | -------| -------------- | -------- | -----------|
| sessionStr    | String |               | 否       |子会话码|
| parentTopicType | String | | 是 |父级枚举|
| parentTopicId | int | | 是 |父级Id|
| topicType | String | | 否 |当前枚举|
| topicId | int | | 否 |当前id|
| qrCode | String | empty | 是 |渠道跟踪编码|
| wuId | int | 0 | 是 |用户id|
| channelType | String | empty | 是 |渠道枚举|
| ctime | long | currentTime | 是 |当前时间|

## mq发送说明

### 延迟队列

```java
MessageProperties messageProperties = new MessageProperties();
messageProperties.setHeader("x-delay", 3000);//延迟的时间,开始处理时间 - 当前时间
MessageConverter messageConverter = rabbitVipTemplate.getMessageConverter();
Message message = messageConverter.toMessage(33, messageProperties);
rabbitVipTemplate.send(ExchangeConsts.ACT_END, RouteKeyConsts.ACT_END, message);
```

### 非延迟队列

```java
 rabbitVipTemplate.convertAndSend(ExchangeConsts.CARD_OFF, RouteKeyConsts.CARD_OFF, 1);
```

# 1 承载页统计表(data_load_bear)

## 1. 1 访问次数+访问人数

### mq发送条件

> 用户访问承载页时发送,发送前存储user_record记录,将表主键作为mq消息主题发送.

### mq说明

| 注意事项                                | 说明                                          |
| --------------------------------------- | --------------------------------------------- |
| 交换机(exchange)                        | ex.data.load.visit                            |
| 队列(queue)                             | queue.data.load.bear.visit.cnt                |
| 路由键(routeKey)                        | 扇形交换机(fanout,这个参数是否填写不影响结果) |
| 队列类型(是否延迟队列)                  | 非延迟队列                                    |
| 是否插入mq操作记录表(mq_operate_record) | 否                                            |
### 参数说明

| 字段名称     | 字段类型 | 是否可为空 | 说明       | 关联表      |
| ------------ | -------- | ---------- | ---------- | ----------- |
| userRecordId | int      | 否         | 用户记录id | user_record |



## 1.2 分享次数+分享人数

### mq发送条件

> 用户点击分享的时候发送

### mq说明

| 注意事项                                | 说明                                          |
| --------------------------------------- | --------------------------------------------- |
| 交换机(exchange)                        | ex.data.load.share                            |
| 队列(queue)                             | queue.data.load.bear.share.cnt                |
| 路由键(routeKey)                        | 扇形交换机(fanout,这个参数是否填写不影响结果) |
| 队列类型(是否延迟队列)                  | 非延迟队列                                    |
| 是否插入mq操作记录表(mq_operate_record) | 否                                            |
### 参数说明

| 字段名称 | 字段类型 | 是否可为空 | 说明     | 关联表   |
| -------- | -------- | ---------- | -------- | -------- |
| 公共参数 | 公共参数 | 公共参数   | 公共参数 | 公共参数 |

# 2 活动页统计表(data_load_act_date)
## 2.1 访问次数+访问人数

### mq发送条件

> 用户访问活动的时候发送

### mq说明

| 注意事项                                | 说明                                          |
| --------------------------------------- | --------------------------------------------- |
| 交换机(exchange)                        | ex.data.load.act.date.visit                   |
| 队列(queue)                             | queue.data.load.act.date.visit.cnt            |
| 路由键(routeKey)                        | 扇形交换机(fanout,这个参数是否填写不影响结果) |
| 队列类型(是否延迟队列)                  | 非延迟队列                                    |
| 是否插入mq操作记录表(mq_operate_record) | 否                                            |
### 参数说明

| 字段名称     | 字段类型 | 是否可为空 | 说明       | 关联表      |
| ------------ | -------- | ---------- | ---------- | ----------- |
| userRecordId | int      | 否         | 用户记录id | user_record |



## 2.2  分享次数+分享人数

### mq发送条件

> 用户分享活动时发送

### mq说明

| 注意事项                                | 说明                                          |
| --------------------------------------- | --------------------------------------------- |
| 交换机(exchange)                        | ex.data.load.act.date.share                   |
| 队列(queue)                             | queue.data.load.act.date.share.cnt            |
| 路由键(routeKey)                        | 扇形交换机(fanout,这个参数是否填写不影响结果) |
| 队列类型(是否延迟队列)                  | 非延迟队列                                    |
| 是否插入mq操作记录表(mq_operate_record) | 否                                            |
### 参数说明

| 字段名称 | 字段类型 | 是否可为空 | 说明     | 关联表   |
| -------- | -------- | ---------- | -------- | -------- |
| 公共参数 | 公共参数 | 公共参数   | 公共参数 | 公共参数 |

## 2.3 h5访问次数+h5访问人数

### mq发送条件

> 用户通过h5页面访问活动时发送

### mq说明

| 注意事项                                | 说明                                          |
| --------------------------------------- | --------------------------------------------- |
| 交换机(exchange)                        | ex.h5.activity.visit                          |
| 队列(queue)                             | queue.data.load.act.date.visit.h5             |
| 路由键(routeKey)                        | 扇形交换机(fanout,这个参数是否填写不影响结果) |
| 队列类型(是否延迟队列)                  | 非延迟队列                                    |
| 是否插入mq操作记录表(mq_operate_record) | 否                                            |
### 参数说明

| 字段名称    | 字段类型 | 是否可为空 | 说明                    | 关联表   |
| ----------- | -------- | ---------- | ----------------------- | -------- |
| 公共参数    | 公共参数 | 公共参数   | 公共参数                | 公共参数 |
| channelCode | String   | 是         | 渠道编码,兼容以前的版本 |          |

## 2.4 购买相关数据统计
> 购买次数+购买数量+购买获得卡券数+购买人数+支付金额
> 会员购买次数+购买数量+购买获得卡券数+购买人数+支付金额
> 通过分享参与活动数 + 参与活动人数
> 抢购价购买次数+ 抢购价购数量+ 抢购价获得卡券数+抢购购买人数


### mq发送条件

> 用户进入活动获取活动奖品时发送

### mq说明

| 注意事项                                | 说明                                          |
| --------------------------------------- | --------------------------------------------- |
| 交换机(exchange)                        | ex.order.pay.success                          |
| 队列(queue)                             | queue.data.load.act.date.buy.cnt              |
| 路由键(routeKey)                        | 扇形交换机(fanout,这个参数是否填写不影响结果) |
| 队列类型(是否延迟队列)                  | 非延迟队列                                    |
| 是否插入mq操作记录表(mq_operate_record) | 是                                            |
### 参数说明

| 字段名称 | 字段类型 | 是否可为空 | 说明             | 关联表            |
| -------- | -------- | ---------- | ---------------- | ----------------- |
| recordId | int      | 否         | mq操作记录表主键 | mq_operate_record |
### data字段

| 字段名称 | 字段类型 | 是否可为空 | 说明   | 关联表 |
| -------- | -------- | ---------- | ------ | ------ |
| orderId  | int      | 否         | 订单id | orders |

## 2.5 取消支付金额

### mq发送条件

> 活动订单支付取消时发送

### mq说明

| 注意事项                                | 说明                                          |
| --------------------------------------- | --------------------------------------------- |
| 交换机(exchange)                        | ex.order.pay.cancel                           |
| 队列(queue)                             | queue.data.load.act.date.cancel.pay           |
| 路由键(routeKey)                        | 扇形交换机(fanout,这个参数是否填写不影响结果) |
| 队列类型(是否延迟队列)                  | 非延迟队列                                    |
| 是否插入mq操作记录表(mq_operate_record) | 是                                            |
### 参数说明

| 字段名称 | 字段类型 | 是否可为空 | 说明             | 关联表            |
| -------- | -------- | ---------- | ---------------- | ----------------- |
| recordId | int      | 否         | mq操作记录表主键 | mq_operate_record |
### data字段

| 字段名称 | 字段类型 | 是否可为空 | 说明   | 关联表 |
| -------- | -------- | ---------- | ------ | ------ |
| orderId  | int      | 否         | 订单id | orders |

## 2.6 会员卡领取
> 取会员卡数 + 领取会员卡人数
> 员领取会员卡数 + 会员领取会员卡人数
> 新人开通会员数 + 会员续开会员数
> h5激活数量 + 开通会员支付金额 + 会员开通会员支付金额
### mq发送条件

> 用户领取会员卡时发送

### mq说明

| 注意事项                                | 说明                                          |
| --------------------------------------- | --------------------------------------------- |
| 交换机(exchange)                        | ex.vip.card.received                          |
| 队列(queue)                             | queue.data.load.act.date.vip.receive          |
| 路由键(routeKey)                        | 扇形交换机(fanout,这个参数是否填写不影响结果) |
| 队列类型(是否延迟队列)                  | 非延迟队列                                    |
| 是否插入mq操作记录表(mq_operate_record) | 是                                            |
### 参数说明

| 字段名称 | 字段类型 | 是否可为空 | 说明             | 关联表            |
| -------- | -------- | ---------- | ---------------- | ----------------- |
| recordId | int      | 否         | mq操作记录表主键 | mq_operate_record |
### data字段

| 字段名称  | 字段类型 | 是否可为空 | 说明         | 关联表           |
| --------- | -------- | ---------- | ------------ | ---------------- |
| receiveId | int      | 否         | 会员卡领取id | vip_card_receive |

## 2.7 领取红包数据
> 领取红包次数 + 领取红包人数 + 领取红包数量
### mq发送条件

> 用户领取红包时发送

### mq说明

| 注意事项                                | 说明                                          |
| --------------------------------------- | --------------------------------------------- |
| 交换机(exchange)                        | ex.cash.voucher.receive.success               |
| 队列(queue)                             | queue.data.load.act.date.red.pack.receive     |
| 路由键(routeKey)                        | 扇形交换机(fanout,这个参数是否填写不影响结果) |
| 队列类型(是否延迟队列)                  | 非延迟队列                                    |
| 是否插入mq操作记录表(mq_operate_record) | 是                                            |
### 参数说明

| 字段名称 | 字段类型 | 是否可为空 | 说明             | 关联表            |
| -------- | -------- | ---------- | ---------------- | ----------------- |
| recordId | int      | 否         | mq操作记录表主键 | mq_operate_record |
### data字段

| 字段名称     | 字段类型 | 是否可为空 | 说明             | 关联表                |
| ------------ | -------- | ---------- | ---------------- | --------------------- |
| actReceiveId | int      | 否         | 红包活动领取主键 | cash_activity_receive |

## 2.8 核销数据统计
> 核销数量 + 核销人数 + 核销品牌数 + 优惠金额 + 核销金额
> 会员核销数量+核销人数+核销品牌数+优惠金额+核销金额
### mq发送条件

> 用户在各个入口核销时发送

### mq说明

| 注意事项                                | 说明                                          |
| --------------------------------------- | --------------------------------------------- |
| 交换机(exchange)                        | ex.card.off                                   |
| 队列(queue)                             | queue.data.load.act.date.off.cnt              |
| 路由键(routeKey)                        | 扇形交换机(fanout,这个参数是否填写不影响结果) |
| 队列类型(是否延迟队列)                  | 非延迟队列                                    |
| 是否插入mq操作记录表(mq_operate_record) | 是                                            |
### 参数说明

| 字段名称 | 字段类型 | 是否可为空 | 说明             | 关联表            |
| -------- | -------- | ---------- | ---------------- | ----------------- |
| recordId | int      | 否         | mq操作记录表主键 | mq_operate_record |
### data字段

| 字段名称 | 字段类型 | 是否可为空 | 说明       | 关联表   |
| -------- | -------- | ---------- | ---------- | -------- |
| offId    | int      | 否         | 核销表主键 | card_off |

## 2.9 核销撤销数据统计
> 撤销次数+撤销人数 + 核销撤销金额
> 会员撤销次数 + 撤销人数 + 核销撤销金额
### mq发送条件

> 用户卡券核销撤销时发送

### mq说明

| 注意事项                                | 说明                                          |
| --------------------------------------- | --------------------------------------------- |
| 交换机(exchange)                        | ex.card.off.revoke                            |
| 队列(queue)                             | queue.data.load.act.date.off.revoke           |
| 路由键(routeKey)                        | 扇形交换机(fanout,这个参数是否填写不影响结果) |
| 队列类型(是否延迟队列)                  | 非延迟队列                                    |
| 是否插入mq操作记录表(mq_operate_record) | 是                                            |
### 参数说明

| 字段名称 | 字段类型 | 是否可为空 | 说明             | 关联表            |
| -------- | -------- | ---------- | ---------------- | ----------------- |
| recordId | int      | 否         | mq操作记录表主键 | mq_operate_record |
### data字段

| 字段名称 | 字段类型 | 是否可为空 | 说明       | 关联表           |
| -------- | -------- | ---------- | ---------- | ---------------- |
| revokeId | int      | 否         | 核销表主键 | shop_card_revoke |

## 3.10 退款数据统计
> 退款次数+退款卡券数+退款人数+退款金额
> 会员退款次数+退款卡券数+退款人数+退款金额
### mq发送条件

> 用户订单退款时发送

### mq说明

| 注意事项                                | 说明                                          |
| --------------------------------------- | --------------------------------------------- |
| 交换机(exchange)                        | ex.order.activity.refund.success              |
| 队列(queue)                             | queue.data.load.act.date.refund.cnt           |
| 路由键(routeKey)                        | 扇形交换机(fanout,这个参数是否填写不影响结果) |
| 队列类型(是否延迟队列)                  | 非延迟队列                                    |
| 是否插入mq操作记录表(mq_operate_record) | 是                                            |
### 参数说明

| 字段名称 | 字段类型 | 是否可为空 | 说明             | 关联表            |
| -------- | -------- | ---------- | ---------------- | ----------------- |
| recordId | int      | 否         | mq操作记录表主键 | mq_operate_record |
### data字段

| 字段名称 | 字段类型 | 是否可为空 | 说明           | 关联表       |
| -------- | -------- | ---------- | -------------- | ------------ |
| refundId | int      | 否         | 订单退款表主键 | order_refund |

## 2.11 卡券过期数据统计
> 过期卡券数+ 过期卡券价值 + 会员过期卡券数 + 会员过期卡券价值
### mq发送条件

> 用户卡券过期时发送

### mq说明

| 注意事项                                | 说明                                          |
| --------------------------------------- | --------------------------------------------- |
| 交换机(exchange)                        | ex.card.code.overdue                          |
| 队列(queue)                             | queue.data.load.act.date.overdue.num          |
| 路由键(routeKey)                        | 扇形交换机(fanout,这个参数是否填写不影响结果) |
| 队列类型(是否延迟队列)                  | 非延迟队列                                    |
| 是否插入mq操作记录表(mq_operate_record) | 是                                            |
### 参数说明

| 字段名称 | 字段类型 | 是否可为空 | 说明             | 关联表            |
| -------- | -------- | ---------- | ---------------- | ----------------- |
| recordId | int      | 否         | mq操作记录表主键 | mq_operate_record |
### data字段

| 字段名称  | 字段类型 | 是否可为空 | 说明       | 关联表            |
| --------- | -------- | ---------- | ---------- | ----------------- |
| receiveId | int      | 否         | 卡券领取id | card_code_receive |

## 2.12 红包过期数据统计
> 过期未使用红包数+ 过期未使用红包人数
> 会员过期未使用红包数+ 过期未使用红包人数
### mq发送条件

> 用户红包过期时发送

### mq说明

| 注意事项                                | 说明                                          |
| --------------------------------------- | --------------------------------------------- |
| 交换机(exchange)                        | ex.cash.voucher.expire                        |
| 队列(queue)                             | queue.data.load.act.date.expire.red.pack      |
| 路由键(routeKey)                        | 扇形交换机(fanout,这个参数是否填写不影响结果) |
| 队列类型(是否延迟队列)                  | 非延迟队列                                    |
| 是否插入mq操作记录表(mq_operate_record) | 否                                            |
### 参数说明

| 字段名称     | 字段类型 | 是否可为空 | 说明       | 关联表                |
| ------------ | -------- | ---------- | ---------- | --------------------- |
| actReceiveId | int      | 否         | 红包领取id | cash_activity_receive |
| wuId         | int      | 是         | 用户id     |                       |
| redPackNum   | int      | 否         | 过期数量   |                       |
| orderId      | int      | 否         | 订单id     |                       |

## 2.13 霸王餐参与抽奖数据

> 参与抽奖次数 + 参与抽奖人数
### mq发送条件

> 用户参与霸王餐时发送

### mq说明

| 注意事项                                | 说明                                          |
| --------------------------------------- | --------------------------------------------- |
| 交换机(exchange)                        | ex.act.join.lottery                           |
| 队列(queue)                             | queue.data.load.act.date.join.lottery         |
| 路由键(routeKey)                        | 扇形交换机(fanout,这个参数是否填写不影响结果) |
| 队列类型(是否延迟队列)                  | 非延迟队列                                    |
| 是否插入mq操作记录表(mq_operate_record) | 否                                            |
### 参数说明

| 字段名称    | 字段类型 | 是否可为空 | 说明                   | 关联表   |
| ----------- | -------- | ---------- | ---------------------- | -------- |
| 公共参数    | 公共参数 | 公共参数   | 公共参数               | 公共参数 |

## 2.14 霸王餐分享访问数据

> 分享访问次数 + 分享访问人数
### mq发送条件

> 用户分享霸王餐数据时发送

### mq说明

| 注意事项                                | 说明                                          |
| --------------------------------------- | --------------------------------------------- |
| 交换机(exchange)                        | ex.visit.by.share                             |
| 队列(queue)                             | queue.data.load.act.date.visit.by.share       |
| 路由键(routeKey)                        | 扇形交换机(fanout,这个参数是否填写不影响结果) |
| 队列类型(是否延迟队列)                  | 非延迟队列                                    |
| 是否插入mq操作记录表(mq_operate_record) | 否                                            |
### 参数说明

| 字段名称 | 字段类型 | 是否可为空 | 说明                              | 关联表   |
| -------- | -------- | ---------- | --------------------------------- | -------- |
| 公共参数 | 公共参数 | 公共参数   | 公共参数                          | 公共参数 |
| joinType | int      | 否         | 参与类型 1.开团 2.参团 3.组团成功 |          |

## 2.15 参团次数
> 开团数,参团数,成团数
### mq发送条件

> 用户开团,参团的时候发送

### mq说明

| 注意事项               | 说明                                          |
| ---------------------- | --------------------------------------------- |
| 交换机(exchange)       | ex.act.group.join                             |
| 队列(queue)            | queue.act.group.join.cnt                      |
| 路由键(routeKey)       | 扇形交换机(fanout,这个参数是否填写不影响结果) |
| 队列类型(是否延迟队列) | 非延迟队列                                    |
| 是否插入mq操作记录表(mq_operate_record) | 否|

### 参数说明

| 字段名称 | 字段类型 | 是否可为空 | 说明                              | 关联表   |
| -------- | -------- | ---------- | --------------------------------- | -------- |
| 公共参数 | 公共参数 | 公共参数   | 公共参数                          | 公共参数 |
| joinType | int      | 否         | 参与类型 1.开团 2.参团 3.组团成功 |          |
| wuId     | int      | 否         | 参与用户id                        |          |

# 3 营销页统计表

> 待续...

# 4 小程序页统计表
> 待续...